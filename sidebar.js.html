<script>

$('#viewLargeFormat').click(function() {
	var type = $('input[name=emailType]:checked').val();
	// ADD
	// add ablity to edit from within large modal
	// then need to know if in edit mode or display mode before displaying
	// set a session variable when either is clicked
	showToast();
	google.script.run.withSuccessHandler(successViewLargeFormat).viewLargeFormat(type);
});

function successViewLargeFormat() {
	hideToast();
}


$('#editEmailTextBtn').click(function(){
	$('#emailBodyText').hide();
	$('#editEmailBodyTextDiv').show();
	$(this).hide();
	$('#cancelEmailTextBtn').show();
	$('#saveEmailTextBtn').show();
});

$('#cancelEmailTextBtn').click(function(){
	$('#emailBodyText').show();
	$('#editEmailBodyTextDiv').hide();
	$(this).hide();
	$('#editEmailTextBtn').show();
	$('#saveEmailTextBtn').hide();
});

$('#saveEmailTextBtn').click(function() {
	var data = {};
	var emailBodyText = $('#editEmailBodyTextArea').val();
	if (!emailBodyText || emailBodyText == '[ no body ]') {
		$('#editEmailBodyTextArea').val('').focus();
	}
	$('#mask').show();
	$('#toast').css('transform','translateY(-60px)');
	google.script.run.withSuccessHandler(successSaveEmailBodyText).saveEmailBodyText(emailBodyText);
});



$('#cancelEmailHtmlBtn').click(function(){
	$('#emailBodyHtml').show();
	$('#editEmailBodyHtmlDiv').hide();
	$(this).hide();
	$('#editEmailHtmlBtn').show();
	$('#saveEmailHtmlBtn').hide();
});

$('#editEmailHtmlBtn').click(function(){
	$('#emailBodyHtml').hide();
	$('#editEmailBodyHtmlDiv').show();
	$(this).hide();
	$('#cancelEmailHtmlBtn').show();
	$('#saveEmailHtmlBtn').show();
});

$('#saveEmailHtmlBtn').click(function() {
	var data = {};
	var emailBodyHtml = $('#editEmailBodyHtmlArea').val();
	if (!emailBodyHtml || emailBodyHtml == '[ no body ]') {
		$('#editEmailBodyHtmlArea').val('');
	}
	$('#mask').show();
	$('#toast').css('transform','translateY(-60px)');
	google.script.run.withSuccessHandler(successSaveEmailBodyHtml).saveEmailBodyHtml(emailBodyHtml);
});



$('#cancelEmailSubjectBtn').click(function(){
	$(this).hide();
	$('#editEmailSubjectBtn').show();
	$('#saveEmailSubjectBtn').hide();
	$('#emailSubjectDiv').show();
	$('#editEmailSubjectDiv').hide();
});

$('#editEmailSubjectBtn').click(function(){
	$('#emailSubjectDiv').hide();
	$('#editEmailSubjectDiv').show();
	$('#saveEmailSubjectBtn').show();
	if ($('#emailSubjectSpan').text() == '[ no subject ]') {
		$('#editEmailSubjectInput').focus().val('');
	} else {
		$('#editEmailSubjectInput').focus().val($('#emailSubjectSpan').text());
	}
	$('#editEmailSubjectBtn').hide();
	$('#cancelEmailSubjectBtn').show();
});

$('#saveEmailSubjectBtn').click(function() {
	var subject = $('#editEmailSubjectInput').val();
	if (!subject) {
		$('#alertMessage').text('Please provide a subject');
		alertModal.open();
		return;
	}
	$('#mask').show();
	$('#toast').css('transform','translateY(-60px)');
	google.script.run.withSuccessHandler(successSaveEmailSubject).saveEmailSubject(subject);
});



$('#cancelEmailToColNameBtn').click(function(){
	$(this).hide();
	$('#editEmailToColNameBtn').show();
	$('#saveEmailToColNameBtn').hide();
	$('#emailToColNameDiv').show();
	$('#editEmailToColNameDiv').hide();
});

$('#editEmailToColNameBtn').click(function(){
	$('#emailToColNameDiv').hide();
	$('#editEmailToColNameDiv').show();
	$('#saveEmailToColNameBtn').show();
	if ($('#emailToColNameSpan').text() == '[ no column name ]') {
		$('#editEmailToColNameInput').focus().val('');
	} else {
		$('#editEmailToColNameInput').focus().val($('#emailToColNameSpan').text());
	}
	$('#editEmailToColNameBtn').hide();
	$('#cancelEmailToColNameBtn').show();
});

$('#saveEmailToColNameBtn').click(function() {
	var colName = $('#editEmailToColNameInput').val();
	if (!colName) {
		$('#alertMessage').text('Please provide a column name');
		alertModal.open();
		return;
	}
	$('#mask').show();
	$('#toast').css('transform','translateY(-60px)');
	google.script.run.withSuccessHandler(successSaveEmailToColName).saveEmailToColName(colName);
});



$('#cancelPdfFileNameBtn').click(function(){
	$(this).hide();
	$('#editPdfFileNameBtn').show();
	$('#savePdfFileNameBtn').hide();
	$('#pdfFileNameDiv').show();
	$('#editPdfFileNameDiv').hide();
});

$('#editPdfFileNameBtn').click(function(){
	$('#pdfFileNameDiv').hide();
	$('#editPdfFileNameDiv').show();
	$('#savePdfFileNameBtn').show();
	if ($('#pdfFileNameSpan').text() == '[ no file name ]') {
		$('#editPdfFileNameInput').focus().val('');
	} else {
		$('#editPdfFileNameInput').focus().val($('#pdfFileNameSpan').text());
	}
	$('#editPdfFileNameBtn').hide();
	$('#cancelPdfFileNameBtn').show();
});

$('#savePdfFileNameBtn').click(function() {
	var fileName = $('#editPdfFileNameInput').val();
	if (!fileName) {
		$('#alertMessage').text('Please provide a file name');
		alertModal.open();
		return;
	}
	$('#mask').show();
	$('#toast').css('transform','translateY(-60px)');
	google.script.run.withSuccessHandler(successSavePdfFileName).savePdfFileName(fileName);
});



$('#cancelTempFolderUrlBtn').click(function(){
	$(this).hide();
	$('#editTempFolderUrlBtn').show();
	$('#saveTempFolderUrlBtn').hide();
	$('#tempFolderUrlDiv').show();
	$('#editTempFolderUrlDiv').hide();
});

$('#editTempFolderUrlBtn').click(function(){
	$('#tempFolderUrlDiv').hide();
	$('#editTempFolderUrlDiv').show();
	$('#saveTempFolderUrlBtn').show();
	if ($('#tempFolderUrlSpan').text() == '[ no url ]') {
		$('#editTempFolderUrlInput').focus().val('');
	} else {
		$('#editTempFolderUrlInput').focus().val($('#tempFolderUrlSpan').text());
	}
	$('#editTempFolderUrlBtn').hide();
	$('#cancelTempFolderUrlBtn').show();
});

$('#saveTempFolderUrlBtn').click(function() {
	var url = $('#editTempFolderUrlInput').val();
	if (!url) {
		$('#alertMessage').text('Please provide a URL');
		alertModal.open();
		return;
	}
	$('#mask').show();
	$('#toast').css('transform','translateY(-60px)');
	google.script.run.withSuccessHandler(successSaveTempFolderUrl).saveTempFolderUrl(url);
});



$('#cancelPdfFolderUrlBtn').click(function(){
	$(this).hide();
	$('#editPdfFolderUrlBtn').show();
	$('#savePdfFolderUrlBtn').hide();
	$('#pdfFolderUrlDiv').show();
	$('#editPdfFolderUrlDiv').hide();
});

$('#editPdfFolderUrlBtn').click(function(){
	$('#pdfFolderUrlDiv').hide();
	$('#editPdfFolderUrlDiv').show();
	$('#savePdfFolderUrlBtn').show();
	if ($('#pdfFolderUrlSpan').text() == '[ no url ]') {
		$('#editPdfFolderUrlInput').focus().val('');
	} else {
		$('#editPdfFolderUrlInput').focus().val($('#pdfFolderUrlSpan').text());
	}
	$('#editPdfFolderUrlBtn').hide();
	$('#cancelPdfFolderUrlBtn').show();
});

$('#savePdfFolderUrlBtn').click(function() {
	var url = $('#editPdfFolderUrlInput').val();
	if (!url) {
		$('#alertMessage').text('Please provide a URL');
		alertModal.open();
		return;
	}
	$('#mask').show();
	$('#toast').css('transform','translateY(-60px)');
	google.script.run.withSuccessHandler(successSavePdfFolderUrl).savePdfFolderUrl(url);
});



$('#cancelDocumentTemplateUrlBtn').click(function(){
	$(this).hide();
	$('#editDocumentTemplateUrlBtn').show();
	$('#saveDocumentTemplateUrlBtn').hide();
	$('#documentTemplateUrlDiv').show();
	$('#editDocumentTemplateUrlDiv').hide();
});

$('#editDocumentTemplateUrlBtn').click(function(){
	$('#documentTemplateUrlDiv').hide();
	$('#editDocumentTemplateUrlDiv').show();
	$('#saveDocumentTemplateUrlBtn').show();
	if ($('#documentTemplateUrlSpan').text() == '[ no url ]') {
		$('#editDocumentTemplateUrlInput').focus().val('');
	} else {
		$('#editDocumentTemplateUrlInput').focus().val($('#documentTemplateUrlSpan').text());
	}
	$('#editDocumentTemplateUrlBtn').hide();
	$('#cancelDocumentTemplateUrlBtn').show();
});

$('#saveDocumentTemplateUrlBtn').click(function() {
	var url = $('#editDocumentTemplateUrlInput').val();
	if (!url) {
		$('#alertMessage').text('Please provide a URL');
		alertModal.open();
		return;
	}
	$('#mask').show();
	$('#toast').css('transform','translateY(-60px)');
	google.script.run.withSuccessHandler(successSaveDocumentTemplateUrl).saveDocumentTemplateUrl(url);
});



$('#fileAndFolderSettingsLink').click(function(e){
	e.preventDefault();
	$('.link').hide();
	$('#fileAndFolderSettings').show();
	$('.sidenav').sidenav('close');
});

$('#emailSettingsLink').click(function(e){
	e.preventDefault();
	$('.link').hide();
	$('#emailSettings').show();
	$('.sidenav').sidenav('close');
});

$('#mergeAndEmailLink').click(function(e){
	e.preventDefault();
	$('.link').hide();
	$('#mergeAndEmail').show();
	$('.sidenav').sidenav('close');
});

$('#deleteSettingsLink').click(function(e) {
	e.preventDefault();
	$('#dialogMessage').text("Delete all settings?");
	dialogModal.open();
	$('#okayBtn').off('click');
	$('#okayBtn').click(function(){
		showToast();
		google.script.run.withSuccessHandler(successDeleteDocumentProperties).deleteDocumentProperties();
	});

});

function successDeleteDocumentProperties() {
	hideToast();
}

$('#sendEmails').change(function(){

	if ($(this).prop("checked") == true) {
		if ($('#createPdfFiles').prop("checked") == true) {
			$('#includePdfAttachmentDiv').show();
		} else {
			$('#includePdfAttachmentDiv').hide();
		}
	} else {
		$('#includePdfAttachmentDiv').hide();
	}
});

$('#createPdfFiles').change(function(){
	if ($(this).prop("checked") == true) {
		$('#savePdfFilesDiv').show();
		if ($('#sendEmails').prop("checked") == true) {
			$('#includePdfAttachmentDiv').show();
		} else {
			$('#includePdfAttachmentDiv').hide();
		}
	} else {
		$('#savePdfFilesDiv').hide();
		$('#includePdfAttachmentDiv').hide();
	}
});

$('select').formSelect();

$('.sidenav').sidenav();

$('#closeMenu').click(function(e){
	e.preventDefault();
	$('.sidenav').sidenav('close');
});

$('input[name=emailType]').change(function() {

	var type = $(this).val();
	if (type == 'draft') {
		$('#emailBodyDraft').show();
		$('#emailBodyTextDiv').hide();
		$('#emailBodyHtmlDiv').hide();
	}
	else if (type == 'text') {
		$('#emailBodyTextDiv').show();
		$('#emailBodyHtmlDiv').hide();
		$('#emailBodyDraft').hide();
	}
	else if (type == 'html') {
		$('#emailBodyTextDiv').hide();
		$('#emailBodyHtmlDiv').show();
		$('#emailBodyDraft').hide();

	}
});

$('#mergeAndEmailBtn').click(function(e) {
	e.preventDefault();

	var rowsToProcess = $('#selectRows').val();
	if (!rowsToProcess) {
		$('#alertMessage').text('Please select the Rows to Process');
		alertModal.open();
		return;
	}

	var formArray = $('#form1').serializeArray();
	var formData = objectifyForm(formArray);

	if (!formData.createPdfFiles && !formData.sendEmails) {
		$('#alertMessage').text('Please select "Create PDF Files or "Send Emails');
		alertModal.open();
		return;
	};
	if (formData.createPdfFiles && !formData.savePdfFiles && !formData.sendEmails) {
		$('#alertMessage').text('Please select "Save PDF Files or "Send Emails');
		alertModal.open();
		return;
	}
	if (formData.sendEmails) {
		var type = $('input[name=emailType]:checked').val();
		if (type == 'text') {
			var emailBodyText = $('#emailBodyText').html();
			if (!emailBodyText) {
				$('#alertMessage').text('Email Text Body is blank');
				alertModal.open();
				return;
			}
		} else if (type == 'html') {
			var emailBodyHtml = $('#emailBodyHtml').html();
			if (!emailBodyHtml) {
				$('#alertMessage').text('Email HTML Body is blank');
				alertModal.open();
				return;
			}
		}
	}

	if (rowsToProcess == "allRows") $('#dialogMessage').text("Process ALL rows?");
	else if (rowsToProcess == 'firstRow') $('#dialogMessage').text("Process First Row?");

	dialogModal.open();
	$('#okayBtn').off('click');
	$('#okayBtn').click(function(){
		showToast();
		var emailType = $('input[name=emailType]:checked').val();
		google.script.run.withSuccessHandler(processRow).getInitialData(emailType,formData.sendEmails);
	});
});


function processRow(data) {
	if (!data.success) {
		$('#alertMessage').text(data.errorMessage);
		alertModal.open();
		hideToast();
		return;
	}
	var draftBody = data.draftBody;
	var numRows = data.numRows;
	var headers = data.headers;
	data = {};
	var formArray = $('#form1').serializeArray();
	data = objectifyForm(formArray);
	data.emailType = $('input[name=emailType]:checked').val();
	data.rowNum = 3;

	var rowsToProcess = $('#selectRows').val();
	if (rowsToProcess == 'firstRow') {
		data.remainingRows = 1;
	} else if (rowsToProcess == 'allRows') {
		data.remainingRows = numRows;
	}

	data.headers = headers;
	data.draftBody = draftBody;
	google.script.run.withSuccessHandler(successProcessRow).processRow(data);
}

function successProcessRow(data){
    if (!data.success) {
		$('#alertMessage').text(data.errorMessage);
		alertModal.open();
		hideToast();
		return;
	}
    else if (data.remainingRows > 0) {
    	google.script.run.withSuccessHandler(successProcessRow).processRow(data);

    } else {
    	hideToast();
    	return;
    }
}

function successSaveDocumentTemplateUrl(data) {
	if (data.success) {
		$('#documentTemplateUrlSpan').text(data.url);
		$('#editDocumentTemplateUrlDiv').hide();
		$('#documentTemplateUrlDiv').show();
		$('#cancelDocumentTemplateUrlBtn').hide();
		$('#saveDocumentTemplateUrlBtn').hide();
		$('#editDocumentTemplateUrlBtn').show();
	} else if (!data.success) {
		$('#alertMessage').text(data.errorMessage);
		alertModal.open();
	}
	hideToast();
}

function successSavePdfFolderUrl(data) {
	if (data.success) {
		$('#pdfFolderUrlSpan').text(data.url);
		$('#editPdfFolderUrlDiv').hide();
		$('#pdfFolderUrlDiv').show();
		$('#cancelPdfFolderUrlBtn').hide();
		$('#savePdfFolderUrlBtn').hide();
		$('#editPdfFolderUrlBtn').show();
		$('#mask').hide();
		$('#toast').css('transform','');
	} else if (!data.success) {
		$('#alertMessage').text(data.errorMessage);
		alertModal.open();
	}
	hideToast();
}

function successSaveTempFolderUrl(data) {
	if (data.success) {
		$('#tempFolderUrlSpan').text(data.url);
		$('#editTempFolderUrlDiv').hide();
		$('#tempFolderUrlDiv').show();
		$('#cancelTempFolderUrlBtn').hide();
		$('#saveTempFolderUrlBtn').hide();
		$('#editTempFolderUrlBtn').show();
		$('#mask').hide();
		$('#toast').css('transform','');
	} else if (!data.success) {
		$('#alertMessage').text(data.errorMessage);
		alertModal.open();
	}
	hideToast();
}

function successSavePdfFileName(data) {
	if (data.success) {
		$('#pdfFileNameSpan').text(data.fileName);
		$('#editPdfFileNameDiv').hide();
		$('#pdfFileNameDiv').show();
		$('#cancelPdfFileNameBtn').hide();
		$('#savePdfFileNameBtn').hide();
		$('#editPdfFileNameBtn').show();
	}
	hideToast();
}

function successSaveEmailToColName(data) {
	if (data.success) {
		$('#emailToColNameSpan').text(data.colName);
		$('#editEmailToColNameDiv').hide();
		$('#emailToColNameDiv').show();
		$('#cancelEmailToColNameBtn').hide();
		$('#saveEmailToColNameBtn').hide();
		$('#editEmailToColNameBtn').show();
	} else if (!data.success) {
		$('#alertMessage').text(data.errorMessage);
		alertModal.open();
	}
	hideToast();
}

function successSaveEmailSubject(data) {
	if (data.success) {
		$('#emailSubjectSpan').text(data.subject);
		$('#editEmailSubjectDiv').hide();
		$('#emailSubjectDiv').show();
		$('#cancelEmailSubjectBtn').hide();
		$('#saveEmailSubjectBtn').hide();
		$('#editEmailSubjectBtn').show();
	}
	$('#mask').hide();
	$('#toast').css('transform','');
	return;
}

function successSaveEmailBodyText(data) {

	if (data.success) {
		if (!data.emailBodyText) {
			$('#emailBodyText').html('[ no body ]').css('text-align','center').show();
		} else {
			var emailBodyText = data.emailBodyText.replace(/\n/g,"<br>");
			$('#emailBodyText').html(emailBodyText).css('text-align','left').show();
		}
		$('#editEmailBodyTextDiv').hide();
		$('#cancelEmailTextBtn').hide();
		$('#saveEmailTextBtn').hide();
		$('#editEmailTextBtn').show();
	}
	hideToast();
}

function successSaveEmailBodyHtml(data) {

	if (data.success) {
		if (!data.emailBodyHtml) {
			$('#emailBodyHtml').html('[ no body ]').css('text-align','center').show();
		} else {
			$('#emailBodyHtml').html(data.emailBodyHtml).show();
		}
		$('#editEmailBodyHtmlDiv').hide();
		$('#emailBodyHtmlDiv').show();
		$('#cancelEmailHtmlBtn').hide();
		$('#saveEmailHtmlBtn').hide();
		$('#editEmailHtmlBtn').show();
	}
	hideToast();
}


/*******************************************************/

document.addEventListener('DOMContentLoaded', function() {
	var elems = document.querySelectorAll('select');
	var instances = M.FormSelect.init(elems,{});

	var elems = document.querySelectorAll('.tooltipped');
    var instances = M.Tooltip.init(elems,{margin:20,enterDelay:400});
});

function objectifyForm(formArray) {
	var returnArray = {};
	for (var i = 0; i < formArray.length; i++){
		returnArray[formArray[i]['name']] = formArray[i]['value'];
	}
	return returnArray;
}

function hideToast() {
	$('#mask').hide();
	$('#toast').css('transform','');
}

function showToast() {
	$('#mask').show();
	$('#toast').css('transform','translateY(-60px)');
}

</script>